Connect-VBRServer -Server localhost

# Fetch malware detection events using the official command
$malwareDetectionEvents = Get-VBRMalwareDetectionEvent | ForEach-Object {

    $detectionTime    = $_.DetectionTime.ToUniversalTime().ToLocalTime()
    [PSCustomObject]@{
        Id            = $_.Id
        ObjectName    = $_.ObjectName
        ObjectId      = $_.ObjectId
        DetectionTime = $detectionTime
        Type          = $_.Type
        CreatedBy     = $_.CreatedBy
        Status        = $_.Status
        Message       = $_.Message
        CreationTime  = $null  # Initialize CreationTime to null
    }
}

# Fetch suspicious activities using the undocumented command (No support)
$suspiciousActivities    = [Veeam.Backup.DBManager.CDBManager]::Instance.SuspiciousActivities.GetAllEvents() |

    ForEach-Object {
        $creationTime    = $_.CreationTimeUtc.ToUniversalTime().ToLocalTime()
        [PSCustomObject]@{
            Id           = $_.Id
            CreationTime = $creationTime
        }
    }

# Join and print the output
$combinedData                   = foreach ($malwareEvent in $malwareDetectionEvents) {
    
    $matchingSuspiciousActivity = $suspiciousActivities | Where-Object { $_.Id -eq $malwareEvent.Id }
    if ($matchingSuspiciousActivity) {
        foreach ($suspiciousActivity in $matchingSuspiciousActivity) {
            [PSCustomObject]@{
                Id            = $malwareEvent.Id
                ObjectName    = $malwareEvent.ObjectName
                ObjectId      = $malwareEvent.ObjectId
                DetectionTime = $malwareEvent.DetectionTime
                Type          = $malwareEvent.Type
                CreatedBy     = $malwareEvent.CreatedBy
                Status        = $malwareEvent.Status
                Message       = $malwareEvent.Message
                CreationTime  = $suspiciousActivity.CreationTime
            }
        }
    } else {
        $malwareEvent
    }
}

$combinedData | Sort-Object -Property CreationTime -Descending | Format-Table -Property ObjectName, CreationTime, DetectionTime, Type, Status, Message

Disconnect-VBRServer
